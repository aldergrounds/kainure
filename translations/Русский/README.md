<div align="center">

# **Kainure**

![C++](https://img.shields.io/badge/C%2B%2B-20-00599C?logo=cplusplus&style=for-the-badge)
![Node.js](https://img.shields.io/badge/Node.js-v22.21.1-339933?logo=node.js&style=for-the-badge)
![V8](https://img.shields.io/badge/V8-12.4-4B8BF5?logo=v8&style=for-the-badge)
![libuv](https://img.shields.io/badge/libuv-v1.48.0-blue?logo=libuv&style=for-the-badge)
![JavaScript](https://img.shields.io/badge/JavaScript-ES2023-F7DF1E?logo=javascript&style=for-the-badge)
![TypeScript](https://img.shields.io/badge/TypeScript-5.x-3178C6?logo=typescript&style=for-the-badge)
![License](https://img.shields.io/badge/License-Apache_2.0-blue?style=for-the-badge)

**Фреймворк для современной разработки SA-MP на JavaScript и TypeScript.**

</div>

## Языки

- Português: [README](../../)
- Deutsch: [README](../Deutsch/README.md)
- English: [README](../English/README.md)
- Español: [README](../Espanol/README.md)
- Français: [README](../Francais/README.md)
- Italiano: [README](../Italiano/README.md)
- Polski: [README](../Polski/README.md)
- Svenska: [README](../Svenska/README.md)
- Türkçe: [README](../Turkce/README.md)

## Содержание

- [**Kainure**](#kainure)
  - [Языки](#языки)
  - [Содержание](#содержание)
  - [Что такое Kainure?](#что-такое-kainure)
  - [Как установить и использовать](#как-установить-и-использовать)
    - [1. Скачивание](#1-скачивание)
    - [2. Структура файлов](#2-структура-файлов)
    - [3. Конфигурация (config.json)](#3-конфигурация-configjson)
  - [API и Функционал](#api-и-функционал)
    - [Философия: Глобальные переменные и никакой сложности](#философия-глобальные-переменные-и-никакой-сложности)
    - [Основной модуль: `api.js`](#основной-модуль-apijs)
      - [`Float`](#float)
      - [`Ref`](#ref)
      - [`Public`](#public)
      - [`Call_Public`](#call_public)
      - [`Native`](#native)
      - [`Native_Hook`](#native_hook)
      - [`Include_Storage`](#include_storage)
    - [Модуль команд: `commands.js`](#модуль-команд-commandsjs)
      - [`Command`](#command)
      - [`Command_Params`](#command_params)
      - [`Alias_Command`](#alias_command)
      - [`Call_Command`](#call_command)
      - [`External_Commands`](#external_commands)
    - [Константы и Типы](#константы-и-типы)
      - [`samp_constants.js`](#samp_constantsjs)
      - [Директория `types/`](#директория-types)
  - [Официальный Гейммод](#официальный-гейммод)
  - [Компиляция](#компиляция)
    - [Windows](#windows)
    - [Linux](#linux)
  - [Лицензия](#лицензия)
    - [Условия и положения использования](#условия-и-положения-использования)
      - [1. Предоставленные разрешения](#1-предоставленные-разрешения)
      - [2. Обязательные условия](#2-обязательные-условия)
      - [3. Ограничения и лимиты](#3-ограничения-и-лимиты)
      - [4. Интеллектуальная собственность](#4-интеллектуальная-собственность)
      - [5. Отказ от гарантий и ограничение ответственности](#5-отказ-от-гарантий-и-ограничение-ответственности)

## Что такое Kainure?

Kainure — это фреймворк, который служит мостом между традиционным San Andreas: Multiplayer (SA-MP) и современной разработкой программного обеспечения. Он позволяет вам писать всю логику вашего гейммода используя **JavaScript** или **TypeScript**, открывая вселенную возможностей с современными инструментами, пакетами и практиками разработки.

Плагин интегрирует среду **Node.js** непосредственно в ваш сервер SA-MP. Используется конкретная версия Node.js — **v22.21.1**, которая несет в себе мощь высокопроизводительных компонентов:
- **Движок V8:** Тот же высокопроизводительный JavaScript-движок, что и в **Google Chrome**, гарантирующий, что ваш код будет выполняться с впечатляющей скоростью и эффективностью.
- **libuv:** Библиотека поддержки, которая управляет I/O (операциями ввода и вывода) асинхронно, позволяя вашему серверу обрабатывать множество операций одновременно без зависаний, что идеально подходит для динамичной игровой среды.

С Kainure вы можете оставить позади ограничения Pawn и принять надежную экосистему для создания более сложных, организованных и простых в поддержке гейммодов.

## Как установить и использовать

### 1. Скачивание

Самую последнюю версию Kainure, включая плагин и все необходимые файлы, можно найти на странице [**Releases**](https://github.com/aldergrounds/kainure/releases) проекта.

### 2. Структура файлов

После скачивания вам нужно организовать файлы в корне вашего сервера SA-MP следующим образом:

```
/ (Корень Гейммода)
├── plugins/
│   └── Kainure.dll  (или Kainure.so на Linux)
├── Kainure/
│   ├── core/
│   ├── types/
│   ├── kainure.js
│   └── config.json (будет создан при первом запуске, если не существует)
└── libnode.dll (или libnode.so на Linux)
```

**Важно:**
- Плагин `Kainure` должен быть добавлен в ваш файл `server.cfg`.
- Библиотека `libnode` (`.dll` или `.so`) должна находиться в **корне** сервера, вместе с исполняемым файлом `samp-server` (или `samp03svr` на Linux).

### 3. Конфигурация (config.json)

В папке `Kainure/` вы найдете файл `config.json`. Если он не существует, плагин создаст его автоматически при первом запуске. Этот файл управляет поведением фреймворка.

```json
{
    "configs": {
        "main_file": "./main.js",
        "encoding": {
            "enabled": false,
            "target": 65001
        }
    },
    "typescript": {
        "enabled": false,
        "output_dir": "./dist"
    }
}
```

- **`main_file`**: Это точка входа вашего gamemode. Kainure начнет выполнять код из этого файла. По умолчанию это может быть `.js` или `.ts` (если TypeScript активирован). Путь `./` представляет собой корень вашего gamemode.

- **`encoding.enabled`**: Определяет, должен ли Kainure конвертировать строки между форматом UTF-8 (стандарт JavaScript) и кодировкой вашего сервера. Если установлено значение `false`, фреймворк будет использовать стандарт `65001` (UTF-8).

- **`encoding.target`**: Определяет целевую кодировку.
   - **Windows**: Обязательно использование **номера Codepage** (например, `1252`).
   - **Linux**: Обязательно использование **имени Codepage** (например, `WINDOWS-1252`).

- **`typescript.enabled`**: Измените на `true`, если вы хотите писать свой код на TypeScript. Kainure автоматически скомпилирует файлы `.ts` в `.js`.
- **`typescript.output_dir`**: Определяет директорию, в которой будут сохранены скомпилированные файлы JavaScript.

## API и Функционал

### Философия: Глобальные переменные и никакой сложности

Kainure был спроектирован так, чтобы быть интуитивно понятным. Вам **не нужно импортировать или делать `require`** ни для одного из основных модулей (`api.js`, `commands.js`, и т.д.) в ваших файлах. Фреймворк автоматически загружает и внедряет весь свой функционал в глобальную область видимости (`globalThis`), делая их немедленно доступными в любой части вашего кода.

### Основной модуль: `api.js`

Этот модуль содержит основные функции для взаимодействия с сервером SA-MP.

#### `Float`

Гарантирует, что число будет обрабатываться как `float`, даже если оно может быть интерпретировано как целое. Это критически важно для нативных функций SA-MP, которые требуют float.

**Когда использовать?** Используйте `Float()` только когда значение является динамическим и неизвестным во время компиляции (например, приходящее из команды или другой функции). Его ручное использование актуально только при передаче значений в `Native.` и `Call_Public.`.

> [!IMPORTANT]
> Если вы пишете явное значение в коде, например `50.0`, препроцессор кода Kainure **автоматически** применит обработку `Float` перед отправкой его в движок V8. Поэтому ручное использование необходимо только в специфических случаях.

```javascript
Command('sethealth', (playerid, params) => {
    const health = { value: 0.1 }; // "0.1", чтобы JavaScript не оптимизировал в целое число.

    if (!Command_Params(params, "f", health))
        return Native.SendClientMessage(playerid, -1, "Использование: /sethealth [здоровье]");

    // `health.value` неизвестно, поэтому используем Float() для гарантии правильной типизации.
    Native.SetPlayerHealth(playerid, Float(health.value));
});
```

#### `Ref`

Помечает переменную для получения значения по ссылке от нативной функции.

**Как это работает?**
- Чтобы **получить** значение от нативной функции (выходные параметры), используйте синтаксис `.$` при передаче переменной.
- Чтобы **передать** значение, содержащееся в переменной, в нативную функцию, используйте её как обычно.
- Начальное значение, переданное в `Ref()`, определяет ожидаемый тип данных.

**Инициализация:**
- **`int`**: `Ref()` или `Ref(0)`
- **`float`**: `Ref(0.1)` (или любой float, не оканчивающийся на абсолютный ноль, чтобы избежать оптимизации в целое число движком JavaScript)
- **`string`**: `Ref("")`
- **`bool`**: `Ref(true)` или `Ref(false)`

```javascript
Command('health', (playerid) => {
    const health = Ref(0.1); // Ожидаем получить float.

    // Используем health.$ чтобы нативная функция заполнила переменную здоровьем игрока.
    Native.GetPlayerHealth(playerid, health.$);

    // Используем просто `health` для чтения значения. Ref автоматически конвертируется в свое значение.
    Native.SendClientMessage(playerid, -1, `Ваше здоровье: ${health}`);
});
```

#### `Public`

Объявляет callback (public) SA-MP, позволяя вашему коду реагировать на игровые события.

**Сигнатуры параметров:** Чтобы Kainure правильно конвертировал типы, необходимо указать сигнатуру в качестве второго параметра, если callback имеет аргументы.
- **`i`**: Целое число
- **`f`**: Float
- **`s`**: String
- **`b`**: Булево значение

**Валидация и ошибки:** Kainure предотвращает выполнение, если:
1. Функция имеет параметры, но сигнатура не указана.
2. Количество символов в сигнатуре отличается от количества параметров, определенных в функции.
3. Сигнатура содержит недопустимые типы (отличные от `i, f, s, b`).

**Возвращаемые значения:**
- `return 1;` или `return true;`: Позволяет callback продолжать выполнение в других скриптах (если они есть). Это поведение по умолчанию, если ничего не возвращается.
- `return 0;` или `return false;`: Предотвращает выполнение callback в других скриптах.

```javascript
// Простой Public без параметров
Public('OnGameModeInit', () => {
    // Логика
    return true;
});

// Public с сигнатурой
Public('OnPlayerText', 'is', (playerid, text) => {
    // Логика
    return true;
});
```

#### `Call_Public`

Вызывает любой public, будь то из самого гейммода, из filterscript-а или кастомный public, созданный с помощью `Public()`.

```javascript
Command('callpublic', (playerid) => {
    // Вызывает public OnPlayerSpawn для игрока, использовавшего команду.
    Call_Public.OnPlayerSpawn(playerid);
});
```

#### `Native`

Вызывает нативную функцию SA-MP или любого загруженного плагина. Просто добавьте префикс `Native.` к имени функции.

```javascript
Public('OnPlayerConnect', (playerid) => {
    Native.SendClientMessage(playerid, -1, "Добро пожаловать на сервер.");
});
```

#### `Native_Hook`

Перехватывает вызов нативной функции, позволяя изменить её поведение или добавить дополнительную логику.

**Порядок выполнения:** Хуки следуют шаблону **LIFO (Last-In, First-Out / Последним пришел — первым ушел)**. Последний созданный хук для нативной функции будет выполнен первым.

**Возвращаемые значения:**
- `return 1;` или `return true;`: Позволяет выполнение нативной функции продолжиться (вызывая следующий хук в стеке или оригинальную функцию).
- `return 0;` или `return false;`: Блокирует выполнение оригинальной нативной функции.

```javascript
Native_Hook('SetPlayerHealth', (playerid, health) => {
    console.log(`[Hook]: Здоровье пользователя ${playerid} было установлено на ${health}.`);
    
    // Позволяет оригинальной нативной функции SetPlayerHealth выполниться.
    return true; 
});
```

#### `Include_Storage`

Предоставляет уникальный и безопасный путь к директории, чтобы `includes` (библиотеки) могли хранить свои собственные данные, избегая конфликтов. Папка всегда будет создаваться внутри `Kainure/includes_storage/`.

```javascript
// Возвращает путь: "Kainure/includes_storage/MyInclude"
const my_data_path = Include_Storage("MyInclude"); 
```

### Модуль команд: `commands.js`

Этот модуль предлагает полную систему для создания и управления командами.

#### `Command`

Регистрирует новую команду на сервере. Функция callback-а может принимать до двух параметров: `playerid` и `params`. Оба опциональны.

```javascript
// Простая команда без параметров
Command('pos', (playerid) => {
    const x = Ref(0.1), y = Ref(0.1), z = Ref(0.1);

    Native.GetPlayerPos(playerid, x.$, y.$, z.$);
    Native.SendClientMessage(playerid, -1, `Позиция: ${x}, ${y}, ${z}`);
});
```

#### `Command_Params`

Обрабатывает и извлекает параметры из строки команды, аналогично `sscanf`.

**Как это работает?**
- Переменная, которая получит значение, должна быть объектом со свойством `value` (например: `{ value: 0 }`).
- Начальное значение свойства `value` определяет ожидаемый тип данных.
- После функции извлеченное значение будет доступно через `.value`.

```javascript
Command('givemoney', (playerid, params) => {
    const giveid = { value: 0 }; // Ожидает целое число
    const amount = { value: 0 }; // Ожидает целое число

    if (!Command_Params(params, "ii", giveid, amount))
        return Native.SendClientMessage(playerid, -1, "Правильное использование: /givemoney [ID] [Сумма]");

    Native.GivePlayerMoney(giveid.value, amount.value);
    // Обратите внимание на использование .value для доступа к обработанным значениям.
});
```

#### `Alias_Command`

Создает один или несколько алиасов (альтернативных имен) для существующей команды.

```javascript
// Создает основную команду
Command('showlife', (playerid) => { /* ... */ });

// Создает алиасы для команды 'showlife'
Alias_Command('showlife', 'life', 'hp', 'health');
```
Теперь `/showlife`, `/life`, `/hp` и `/health` будут выполнять один и тот же код.

#### `Call_Command`

Вызывает команду программно из вашего кода.

```javascript
// Пример: Заставляет игрока 0 выполнить /givemoney 1 500, то есть он даст 500 денег игроку 1.
Call_Command("givemoney", "1 500", 0 /* или playerid */);

// playerid в конце опционален. Однако, это нелогично, так как команды базируются на игроках.
Call_Command("announcement", "Сервер перезагрузится через 1 минуту!");
```

#### `External_Commands`

Эта функция используется для регистрации команд, которые **не были созданы в среде Kainure**, но существуют в других скриптах.

При регистрации команды как внешней Kainure гарантирует, что глобальные callback команд (`OnPlayerCommandReceived` и `OnPlayerCommandPerformed`) будут вызываться правильно для этих команд, интегрируя их в поток фреймворка.

```javascript
// Регистрация команд, существующих в filterscript
External_Commands("login", "register", "help");
```

### Константы и Типы

#### `samp_constants.js`

Этот файл содержит все стандартные константы и определения SA-MP (такие как `MAX_PLAYERS`, `WEAPON_DEAGLE`, и т.д.). Он загружается глобально, поэтому вы можете использовать эти константы прямо в своем коде без необходимости их объявления.

#### Директория `types/`

Эта директория хранит файлы определения типов (`.d.ts`) для всего API Kainure. Если вы используете TypeScript, эти файлы обеспечат автодополнение, проверку типов и гораздо более богатый и безопасный опыт разработки в вашем редакторе кода.

## Официальный Гейммод

Чтобы ускорить ваше обучение и увидеть Kainure в действии, **AlderGrounds** поддерживает полный гейммод с открытым исходным кодом, созданный полностью на этом фреймворке. Он служит фундаментальной частью живой документации и лучшим местом для поиска практических примеров.

Если у вас есть вопросы о том, как структурировать ваш код, использовать API или реализовывать сложные функции, этот репозиторий является вашим основным источником информации.

➡️ **Изучить Официальный Гейммод:** [Gamemode AlderGrounds](https://github.com/aldergrounds/gamemode)

## Компиляция

Если вы хотите скомпилировать Kainure из исходного кода, следуйте инструкциям для вашей операционной системы.

### Windows

1. **Требования**:
   - [Visual Studio](https://visualstudio.microsoft.com/) с установленным набором инструментов "Разработка классических приложений на C++".
2. **Шаги**:
   - Перейдите в директорию `build/Windows/`.
   - Откройте соответствующий файл решения для вашей версии Visual Studio:
      - `Kainure.sln`: Для Visual Studio 2022 или ниже.
      - `Kainure.slnx`: Для Visual Studio 2026.
   - В Visual Studio убедитесь, что конфигурация сборки установлена на **Release**, а платформа на **x86**.
   - Скомпилируйте решение (обычно нажатием `Ctrl+Shift+B` или через меню `Build > Build Solution`).
   - Скомпилированный `Kainure.dll` можно будет найти в папке `compiled/Windows/`.

### Linux

1. **Требования**:
   - [Docker](https://www.docker.com/) установлен и запущен.
2. **Шаги**:
   - Процесс автоматизирован скриптом. Просто выполните следующую команду из корня проекта:
      ```bash
      ./build/Linux/compile.sh
      ```
   - Скрипт выполнит следующее:
      1. Соберет Docker-образ (`kainure-builder-x86`) со всеми необходимыми зависимостями (Ubuntu 18.04, g++-9, CMake).
      2. Запустит контейнер из образа для компиляции проекта.
      3. Скопирует полученный `Kainure.so` в папку `compiled/Linux/`.
      4. Очистит созданный Docker-образ.

## Лицензия

Copyright © **AlderGrounds**

Это программное обеспечение лицензировано на условиях Лицензии Apache, Версия 2.0 ("Лицензия"); вы не можете использовать это программное обеспечение, кроме как в соответствии с Лицензией. Копию Лицензии можно получить по адресу: [Apache License 2.0](http://www.apache.org/licenses/LICENSE-2.0)

### Условия и положения использования

#### 1. Предоставленные разрешения

Настоящая лицензия бесплатно предоставляет любому лицу, получившему копию данного программного обеспечения и сопутствующих файлов документации, следующие права:
- Использовать, копировать, модифицировать и распространять программное обеспечение на любом носителе или в любом формате, для любых целей, коммерческих или некоммерческих
- Объединять, публиковать, распространять, сублицензировать и/или продавать копии программного обеспечения
- Разрешать лицам, которым предоставляется программное обеспечение, делать то же самое

#### 2. Обязательные условия

Все дистрибутивы программного обеспечения или производные работы должны:
- Включать полную копию данной лицензии
- Четко указывать любые изменения, внесенные в оригинальный исходный код
- Сохранять все уведомления об авторских правах, патентах, товарных знаках и атрибуции
- Предоставлять надлежащую документацию о внедренных изменениях
- Сохранять уведомление о лицензии и гарантии во всех копиях

#### 3. Ограничения и лимиты

- Данная лицензия не предоставляет разрешения на использование товарных знаков, логотипов или торговых наименований **AlderGrounds**
- Вклад в исходный код должен быть лицензирован на тех же условиях, что и данная лицензия
- Использование имен участников для одобрения или продвижения продуктов, производных от этого программного обеспечения, требует предварительного специального разрешения

#### 4. Интеллектуальная собственность

Программное обеспечение и вся сопутствующая документация защищены законами об авторском праве и международными договорами. **AlderGrounds** сохраняет за собой все права, титулы и интересы, не предоставленные явно данной лицензией.

#### 5. Отказ от гарантий и ограничение ответственности

ПРОГРАММНОЕ ОБЕСПЕЧЕНИЕ ПРЕДОСТАВЛЯЕТСЯ «КАК ЕСТЬ», БЕЗ КАКИХ-ЛИБО ГАРАНТИЙ, ЯВНЫХ ИЛИ ПОДРАЗУМЕВАЕМЫХ, ВКЛЮЧАЯ, НО НЕ ОГРАНИЧИВАЯСЬ, ГАРАНТИЯМИ ТОВАРНОЙ ПРИГОДНОСТИ, ПРИГОДНОСТИ ДЛЯ ОПРЕДЕЛЕННОЙ ЦЕЛИ И НЕНАРУШЕНИЯ ПРАВ.

НИ ПРИ КАКИХ ОБСТОЯТЕЛЬСТВАХ АВТОРЫ ИЛИ ВЛАДЕЛЬЦЫ АВТОРСКИХ ПРАВ НЕ НЕСУТ ОТВЕТСТВЕННОСТИ ПО КАКИМ-ЛИБО ИСКАМ, ЗА УБЫТКИ ИЛИ ИНУЮ ОТВЕТСТВЕННОСТЬ, БУДЬ ТО В РАМКАХ ИСКА ПО ДОГОВОРУ, ДЕЛИКТУ ИЛИ ИНЫМ ОБРАЗОМ, ВОЗНИКАЮЩИМ ИЗ, ИЛИ В СВЯЗИ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ ИЛИ ИСПОЛЬЗОВАНИЕМ ИЛИ ИНЫМИ ДЕЙСТВИЯМИ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ.

---

Для получения подробной информации о Лицензии Apache 2.0, обратитесь к: http://www.apache.org/licenses/LICENSE-2.0